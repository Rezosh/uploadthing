import { Callout, Steps } from "nextra-theme-docs";

# Usage with Next.js App Router

<Callout type="info">
  Make sure you've gone through the [getting started](/getting-started) before
  continuing.
</Callout>

<Steps>

### Update import in `~/server/uploadthing.ts`

Next.js provides a few helpers over the regular `Request` type. To get the
correct type in our `middleware` function, update the import to use the `/next`
entrypoint:

```diff filename="server/uploadthing.ts"
- import { createUploadthing, type FileRouter } from "uploadthing/server";
+ import { createUploadthing, type FileRouter } from "uploadthing/next";
```

You should now see that the type of `req` is `NextRequest` and you'll have
access to helpers such as `req.nextUrl`.

### Create a route handler

Once you've created your file router, it's time to expose it as a new route
handler. Create a new file `/app/api/uploadthing/route.ts` and add the
following:

```ts copy filename="app/api/uploadthing/route.ts"
import { createNextRouteHandler } from "uploadthing/next";

import { uploadRouter } from "~/server/uploadthing";

// Export routes for Next App Router
export const { GET, POST } = createNextRouteHandler({
  router: uploadRouter,
});
```

<Callout type="warning">
  Note: This is the ONLY FILE WHERE THE PATH MATTERS. You need to serve this API
  from `/api/uploadthing` as it is called via webhook to trigger
  `onUploadComplete`.
</Callout>

### Setup UploadThing for React

Install the React package:

```bash copy npm2yarn
npm install @uploadthing/react
```

`@uploadthing/react` provides premade components, as well as a powerful hook
that let's you upload files in your React application. See the
[React docs](/frontend/react) for more information.

### Configure automatic hydration during SSR (recommended)

<Callout type="info">Added in `v5.6`</Callout>

By default, `useUploadThing` (and thus also the premade components) will fetch
your server for the route endpoint permissions which will show a loading state.
By utilizing server components, we can pre-hydrate this data on the server
instead to avoid the loading state and show the route permissions immediately.
This also means no client-side fetch requests are made.

To add SSR hydration for all uploadthing components, simply render the
`<NextSSRPlugin />` hydration helper in the body of your root layout **before**
the children. The before and after is shown below (refresh page to see the
difference):

import { WithoutSSR, WithSSR } from "../../components/ssr-diff";

<div className="mt-6 flex items-center justify-center gap-8">
  <WithoutSSR />
  <WithSSR />
</div>

```tsx copy filename="app/layout.tsx"
import { NextSSRPlugin } from "@uploadthing/react/next-ssr-plugin";
import { extractRouterConfig } from "uploadthing/server";

import { uploadRouter } from "~/server/uploadthing";

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>
        <NextSSRPlugin
          /**
           * The `extractRouterConfig` will extract **only** the route configs
           * from the router to prevent additional information from being
           * leaked to the client. The data passed to the client is the same
           * as if you were to fetch `/api/uploadthing` directly.
           */
          routerConfig={extractRouterConfig(uploadRouter)}
        />
        {children}
      </body>
    </html>
  );
}
```

</Steps>
