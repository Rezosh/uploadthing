import { Callout, Steps } from "nextra-theme-docs";

import FrontendLinks from "../../components/frontend-links.mdx";
import PackageSetup from "../../components/package-setup.mdx";
import FileRouterSetup from "../../components/router-setup.mdx";

# Getting started with Express

> Added in `v5.6`

<PackageSetup>

```bash npm2yarn copy
npm install uploadthing
```

</PackageSetup>

<FileRouterSetup>

```ts copy filename="server/uploadthing.ts"
import { createUploadthing, type FileRouter } from "uploadthing/express";

import { auth } from "~/server/auth";
import { db } from "~/server/db";

const f = createUploadthing();

export const uploadRouter = {
  imageUploader: f({ image: { maxFileSize: "4MB" } })
    .middleware(async ({ req, res }) => {
      // This code runs on your server before upload
      // If the request isn't authenticated, we throw and cancel the upload
      const user = await auth(req, res);
      if (!user) throw new Error("Unauthorized");

      // Whatever is returned here is accessible in onUploadComplete as `metadata`
      return { userId: user.id };
    })
    .onUploadComplete(async ({ metadata, file }) => {
      // This code RUNS ON YOUR SERVER after upload
      console.log("Upload complete for userId:", metadata.userId);

      await db.users
        .update({ imageUrl: file.url })
        .where({ id: metadata.userId });
    }),
} satisfies FileRouter;

export type OurFileRouter = typeof uploadRouter;
```

</FileRouterSetup>

## Register the UploadThing middleware

To expose the FileRouter as HTTP endpoints, register the
`createUploadthingExpressHandler` middleware on your Express app.

<Callout type="warning">
  Note: You need to serve this API from `/api/uploadthing` on your application.
</Callout>

```ts copy filename="src/index.ts"
import express from "express";

import { createUploadthingExpressHandler } from "uploadthing/express";

import { uploadRouter } from "./uploadthing";

const app = express();

app.use(
  "/api/uploadthing",
  createUploadthingExpressHandler({
    router: uploadRouter,
  }),
);
```

<FrontendLinks />
